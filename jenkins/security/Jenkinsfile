pipeline {
    agent any

    environment {
        JAVA_HOME = tool 'JDK21'
        PATH = "${JAVA_HOME}/bin:${env.PATH}"
        SONAR_QUBE_ENV = 'SonarQube'
        SONAR_QUBE_CREDENTIALS_ID = 'sonar-token'
        SNYK_TOKEN_ID = 'snyk-token'
    }

    stages {
        stage('Checkout') {
            steps {
                echo 'Checking out code from SCM...'
                checkout scm
            }
        }

        stage('Full Build') {
            steps {
                echo 'Building all modules to generate compiled classes...'
                sh 'mvn clean compile -DskipTests'
            }
        }

        stage('SAST - SonarQube Analysis') {
            steps {
                echo 'Running SonarQube analysis...'
                withSonarQubeEnv(credentialsId: SONAR_QUBE_CREDENTIALS_ID, installationName: SONAR_QUBE_ENV) {
                    sh 'mvn sonar:sonar -Dsonar.projectKey=petclinic'
                }
            }
        }

        stage('Quality Gate') {
            steps {
                echo 'Checking quality gate status...'
                timeout(time: 5, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }

        stage('SCA - Snyk Security Scan') {
            steps {
                echo 'Running Snyk dependency vulnerability scan...'
                snykSecurity(
                        snykInstallation: 'snyk-cli',
                        snykTokenId: "${SNYK_TOKEN_ID}",
                        severity: 'medium',
                        failOnIssues: false 
                )
            }
        }

        // stage('DAST - OWASP ZAP') {
        //     steps {
        //         echo 'Running OWASP ZAP dynamic application security testing...'
        //         // ZAP scanning commands
        //     }
        // }

        // stage('Container Scan - Trivy') {
        //     steps {
        //         echo 'Scanning Docker images for vulnerabilities...'
        //         // trivy image scanning
        //     }
        // }
    }

    post {
        success {
            echo '✅ Security scan completed successfully.'
        }
        failure {
            echo '❌ Security scan failed.'
            // Uncomment to send notifications
            // emailext (
            //     subject: "Security Scan Failed: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
            //     body: "Security scan failed. Check console output at ${env.BUILD_URL}",
            //     recipientProviders: [[$class: 'DevelopersRecipientProvider']]
            // )
        }
        always {
            echo "Security scan completed with status: ${currentBuild.currentResult}"
        }
    }
}
